<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MOE</title>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>
    // VConsole will be exported to `window.VConsole` by default.
    var vConsole = new window.VConsole();
  </script>

  <style>
    .switch input[role="switch"] {
      opacity: 0;
    }

    .switch input[role="switch"]~.state {
      display: inline-block;
      user-select: none;
    }

    .switch input[role="switch"]~.state>.container {
      position: relative;
      top: 2px;
      display: inline-block;
      border: 2px solid black;
      width: 40px;
      height: 20px;
      border-radius: 11px;
    }

    .switch input[role="switch"]~.state>.container>.position {
      position: relative;
      top: 1px;
      left: 2px;
      display: inline-block;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      background: black;
      opacity: 0.6;
    }

    label input[role="switch"]:checked~.state>.container {
      border: 2px solid red;
    }

    label input[role="switch"]:checked~.state>.container>.position {
      left: 20px;
      background: red;
      opacity: 1;
    }
  </style>

  <script>
    const batteryServiceUUID = "955a180a-0fe2-f5aa-a094-84b8d4f3e8ad"
    const mainServiceUUID = "955a180b-0fe2-f5aa-a094-84b8d4f3e8ad"
    const batteryUUID = "955a1500-0fe2-f5aa-a094-84b8d4f3e8ad"
    const strengthUUID = "955a1504-0fe2-f5aa-a094-84b8d4f3e8ad"
    const AWaveUUID = "955a1506-0fe2-f5aa-a094-84b8d4f3e8ad"
    const BWaveUUID = "955a1505-0fe2-f5aa-a094-84b8d4f3e8ad"
    const waveA = [
      '210100',
      '210102',
      '210104',
      '210106',
      '210108',
      '21010A',
      '21010A',
      '21010A',
      '000000',
      '000000',
      '000000',
      '000000'
    ]

    function hexStringToUint8Array(hexString) {
      if (hexString.length % 2 !== 0) {
        throw new Error('Hex字符串长度必须是偶数');
      }

      const array = new Uint8Array(hexString.length / 2);
      for (let i = 0; i < hexString.length; i += 2) {
        array[i / 2] = parseInt(hexString.substr(i, 2), 16);
      }
      return array;
    }

    function switchEndian(str) {
      if (str.length % 2 !== 0) {
        str = '0' + str
      }
      if (str != "" && str != undefined) {
        var new_str = "";
        for (var x = str.length; x >= 0; x = x - 2) {
          new_str += str.charAt(x);
          new_str += str.charAt(x + 1);
        }
        return new_str;
      } else {
        return str;
      }
    }

    function worker_setup() {
      let count = 0;
      let intervalId;

      self.onmessage = function (e) {
        switch (e.data.code) {
          case 1:
            intervalId = setInterval(async () => {
              count++;
              self.postMessage({ code: 1, msg: 'heartbeat', data: { count: count } })
            }, 100);
            break;
          case 0:
            clearInterval(intervalId);
            break;
        }
      }
    }

    function create_worker() {
      let blob = new Blob(['(' + worker_setup.toString() + ')()']);
      let url = window.URL.createObjectURL(blob);
      return new Worker(url);
    }

    let server;
    let worker = create_worker();
    worker.onmessage = function (e) {
      switch (e.data.code) {
        case 1:
          setBT(e.data.data.count)
          break;
      }
    }

    async function connect() {
      try {
        let device = await navigator.bluetooth.requestDevice({
          filters: [{
            namePrefix: 'D-LAB',
          }],
          optionalServices: [batteryServiceUUID, mainServiceUUID]
        })
        console.log('连接中')
        // console.log(device)
        server = await device.gatt.connect()
        // console.log('PrimaryServices:', await server.getPrimaryServices())
        console.log('连接成功')
        read_battery()
        read_strength()
      } catch (e) {
        if (e.name == 'NotFoundError') {
          console.log('用户取消')
        } else {
          console.error(e)
        }
      }

    }
    async function disconnect(params) {
      if (server) {
        console.log('断开连接')
        await server.disconnect()
      }
    }
    window.onunload = disconnect

    async function read_battery() {
      if (!server) {
        console.log('未连接')
        return
      }
      let service = await server.getPrimaryService(batteryServiceUUID)
      let batteryChar = await service.getCharacteristic(batteryUUID)
      let data = await batteryChar.readValue()
      let battery = data.getInt8()
      console.log("电量:", battery)
      document.getElementById('battery').innerHTML = battery + ""
    }

    async function read_strength(params) {
      if (!server) {
        console.log('未连接')
        return
      }
      let s = await server.getPrimaryService(mainServiceUUID)
      let strengthChar = await s.getCharacteristic(strengthUUID)
      let data = await strengthChar.readValue()
      let res = (data.getUint8(2) << 16) + (data.getUint8(1) << 8) + data.getUint8()
      document.getElementById('strength_b').value = Math.round((res >> 2 & 2047) / 7) + ""
      document.getElementById('strength_a').value = Math.round((res >> 13) / 7) + ""
    }

    async function write_strength() {
      let a_input = document.getElementById('strength_a');
      let b_input = document.getElementById('strength_b');
      let strength_a = parseInt(a_input.value) * 7;
      let strength_b = parseInt(b_input.value) * 7;
      if (strength_a > 2047 || strength_b > 2047) {
        alert('强度不能大于 292')
        return
      }
      if (!server) {
        console.log('未连接')
        return
      }
      let s = await server.getPrimaryService(mainServiceUUID)
      let strengthChar = await s.getCharacteristic(strengthUUID)

      let res = ((strength_a << 11) + strength_b) << 2;
      let value = switchEndian(res.toString(16))
      await strengthChar.writeValueWithoutResponse(hexStringToUint8Array(value))
      console.log('写入完成')
    }

    async function switch_write(e) {
      if (e.target.checked) {
        if (!server) {
          console.log('未连接')
          e.target.checked = false;
          return
        }
        worker.postMessage({ code: 1, msg: 'start', data: {} })
      } else {
        worker.postMessage({ code: 0, msg: 'stop', data: {} })
      }
    }

    async function setBT(count) {
      let i = count % waveA.length;
      let valueA = hexStringToUint8Array(waveA[i]);

      let service = await server.getPrimaryService(mainServiceUUID)
      let characteristicA = await service.getCharacteristic(AWaveUUID)
      characteristicA.writeValue(valueA)
      if (count % 100 === 1) {
        console.log('写入次数' + count)
      }
    }

  </script>
</head>

<body>
  <button onclick="connect()">连接</button>
  <label>
    <span class="label">电量</span>
    <span id="battery">0</span>
  </label>
  <br />
  <label>
    <span class="label">A 强度</span>
    <input type="number" min="0" max="100" name="strength_a" id="strength_a" value="0">
  </label>
  <br />
  <label>
    <span class="label">B 强度</span>
    <input type="number" min="0" max="100" name="strength_b" id="strength_b" value="0">
  </label>
  <br />
  <button onclick="read_strength()">刷新强度</button>
  <button onclick="write_strength()">写入强度</button>
  <br />
  <label class="switch">
    <span class="label">写入波形</span>
    <input type="checkbox" role="switch" oninput="switch_write(event)" />
    <span class="state">
      <span class="container">
        <span class="position"> </span>
      </span>
    </span>
  </label>

</body>

</html>